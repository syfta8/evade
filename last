-- Support for Solara and other executors
local success, err = pcall(function()
    -- Check if we're in Roblox environment
    if game and game:GetService("Players") then
        -- Initialize services
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local LocalPlayer = Players.LocalPlayer
        
        -- Function to check executor
        local function getExecutor()
            if is_sirhurt_closure then
                return "SirHurt"
            elseif syn then
                return "Synapse X"
            elseif secure_load then
                return "Sentinel"
            elseif KRNL_LOADED then
                return "KRNL"
            elseif Pepeg then
                return "Pepeg"
            elseif isvm then
                return "Proxo"
            elseif "Detected" then
                return "ScriptWare"
            else
                return "Unknown"
            end
        end
        
        -- Check executor and notify
        local executor = getExecutor()
        print("‚úÖ Executor detected:", executor)
        print("‚úÖ Solara support: Yes")
        
        -- Wait for player
        while not LocalPlayer do
            wait()
            LocalPlayer = Players.LocalPlayer
        end
        
        -- Load WindUI with executor-specific handling
        local WindUILoaded = false
        local function loadWindUI()
            if WindUILoaded then return true end
            
            local success, windui = pcall(function()
                if executor == "Synapse X" or executor == "ScriptWare" then
                    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
                else
                    -- For Solara and other executors
                    return loadstring(game:HttpGetAsync("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
                end
            end)
            
            if success and windui then
                getgenv().WindUI = windui
                WindUILoaded = true
                return true
            else
                warn("‚ùå Failed to load WindUI")
                return false
            end
        end
        
        -- Alternative UI if WindUI fails
        local function createFallbackUI()
            local screenGui = Instance.new("ScreenGui")
            screenGui.Name = "EmoteChangerUI"
            screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
            
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(0, 400, 0, 300)
            frame.Position = UDim2.new(0.5, -200, 0.5, -150)
            frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
            frame.Parent = screenGui
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -20, 0, 50)
            label.Position = UDim2.new(0, 10, 0, 10)
            label.Text = "Emote Changer (Fallback Mode)"
            label.TextColor3 = Color3.fromRGB(255, 255, 255)
            label.BackgroundTransparency = 1
            label.Parent = frame
            
            return screenGui
        end
        
        -- Main execution
        if loadWindUI() then
            -- Set WindUI theme
            getgenv().WindUI:SetTheme("Plant")
            
            local Confirmed = false
            
            -- Gradient function
            function gradient(text, startColor, endColor)
                local result = ""
                local length = #text
                local r1, g1, b1 = startColor.R * 255, startColor.G * 255, startColor.B * 255
                local r2, g2, b2 = endColor.R * 255, endColor.G * 255, endColor.B * 255
                
                for i = 1, length do
                    local t = (i - 1) / math.max(length - 1, 1)
                    local r = math.floor(r1 + (r2 - r1) * t)
                    local g = math.floor(g1 + (g2 - g1) * t)
                    local b = math.floor(b1 + (b2 - b1) * t)
                    local char = text:sub(i, i)
                    result = result .. string.format('<font color="rgb(%d, %d, %d)">%s</font>', r, g, b, char)
                end
                return result
            end
            
            -- Welcome popup
            getgenv().WindUI:Popup({
                Title = "Welcome to Emote Changer!",
                Icon = "gamepad",
                IconThemed = true,
                Content = "Running on: " .. executor .. "\n\nWelcome to " .. gradient("Emote Changer Pro", Color3.fromHex("#FF6B6B"), Color3.fromHex("#4ECDC4")) .. ".",
                Buttons = {
                    {
                        Title = "Continue",
                        Icon = "arrow-right",
                        Variant = "Primary",
                        Callback = function()
                            Confirmed = true
                        end
                    }
                }
            })
            
            repeat task.wait() until Confirmed
            
            -- Create Window
            local Window = getgenv().WindUI:CreateWindow({
                Title = "Emote Changer Pro",
                Icon = "smile",
                Author = "Solara Supported",
                IconThemed = true,
                Size = UDim2.fromOffset(500, 450),
                Folder = "EmoteChanger",
                Transparent = false,
            })
            
            local VisualTab = Window:Tab({Title = "Emote Changer", Icon = "user"})
            
            -- Emote Changer System
            local Events = ReplicatedStorage:WaitForChild("Events", 10)
            local CharacterFolder = Events:WaitForChild("Character", 10)
            local EmoteRemote = CharacterFolder:WaitForChild("Emote", 10)
            
            -- Emote Changer Variables
            local EmoteChanger = {
                currentEmotes = {"", "", "", "", "", ""},
                selectEmotes = {"", "", "", "", "", ""},
                emoteEnabled = {false, false, false, false, false, false},
                pendingSlot = nil,
                blockOriginalEmote = false,
                hookEnabled = true
            }
            
            -- Function to find best match for emote names
            local function findBestMatch(input, emotes)
                if input == "" then return nil end
                
                local cleanInput = input:lower()
                local bestMatch = nil
                local bestSimilarity = 0
                
                for _, emote in pairs(emotes:GetChildren()) do
                    local emoteName = emote.Name:lower()
                    if emoteName:find(cleanInput, 1, true) then
                        return emote.Name
                    end
                    
                    -- Simple similarity check
                    local similarity = 0
                    if emoteName:sub(1, #cleanInput) == cleanInput then
                        similarity = 0.7
                    elseif emoteName:find(cleanInput) then
                        similarity = 0.5
                    end
                    
                    if similarity > bestSimilarity then
                        bestSimilarity = similarity
                        bestMatch = emote.Name
                    end
                end
                
                return bestMatch
            end
            
            -- Get emote folder
            local emoteFolder = ReplicatedStorage.Items.Emotes
            
            -- Create UI for each emote slot
            for i = 1, 6 do
                VisualTab:Section({Title = "Slot " .. i})
                
                local currentInput = VisualTab:Input({
                    Title = "Current Emote",
                    Placeholder = "Emote to replace...",
                    Value = EmoteChanger.currentEmotes[i],
                    Callback = function(v)
                        local match = findBestMatch(v, emoteFolder)
                        if match then
                            EmoteChanger.currentEmotes[i] = match
                            getgenv().WindUI:Notify({
                                Title = "Emote Changer",
                                Content = "Slot " .. i .. " current: " .. match,
                                Duration = 2
                            })
                        else
                            EmoteChanger.currentEmotes[i] = ""
                        end
                    end
                })
                
                local selectInput = VisualTab:Input({
                    Title = "Replace With",
                    Placeholder = "Emote to use instead...",
                    Value = EmoteChanger.selectEmotes[i],
                    Callback = function(v)
                        local match = findBestMatch(v, emoteFolder)
                        if match then
                            EmoteChanger.selectEmotes[i] = match
                            getgenv().WindUI:Notify({
                                Title = "Emote Changer",
                                Content = "Slot " .. i .. " select: " .. match,
                                Duration = 2
                            })
                        else
                            EmoteChanger.selectEmotes[i] = ""
                        end
                    end
                })
                
                VisualTab:Button({
                    Title = "‚úÖ Apply Slot " .. i,
                    Icon = "check",
                    Callback = function()
                        EmoteChanger.emoteEnabled[i] = (EmoteChanger.currentEmotes[i] ~= "" and EmoteChanger.selectEmotes[i] ~= "")
                        local status = EmoteChanger.emoteEnabled[i] and "enabled" or "disabled"
                        
                        getgenv().WindUI:Notify({
                            Title = "Slot " .. i,
                            Content = "Slot " .. i .. " " .. status,
                            Duration = 2
                        })
                    end
                })
                
                VisualTab:Divider()
            end
            
            -- Control buttons
            VisualTab:Section({Title = "Controls"})
            
            VisualTab:Button({
                Title = "üîÑ Reset All Slots",
                Icon = "refresh-ccw",
                Callback = function()
                    for i = 1, 6 do
                        EmoteChanger.currentEmotes[i] = ""
                        EmoteChanger.selectEmotes[i] = ""
                        EmoteChanger.emoteEnabled[i] = false
                    end
                    
                    getgenv().WindUI:Notify({
                        Title = "Reset Complete",
                        Content = "All slots reset to default",
                        Duration = 3
                    })
                end
            })
            
            VisualTab:Toggle({
                Title = "Enable Emote Changer",
                Value = true,
                Callback = function(state)
                    EmoteChanger.hookEnabled = state
                    getgenv().WindUI:Notify({
                        Title = "Status",
                        Content = "Emote Changer " .. (state and "enabled" or "disabled"),
                        Duration = 2
                    })
                end
            })
            
            -- Hook setup for Solara
            task.spawn(function()
                task.wait(3) -- Wait for UI to load
                
                local oldHook
                oldHook = hookmetamethod(game, "__namecall", function(self, ...)
                    local method = getnamecallmethod()
                    local args = {...}
                    
                    if method == "FireServer" and self == EmoteRemote and type(args[1]) == "string" then
                        if not EmoteChanger.hookEnabled then
                            return oldHook(self, ...)
                        end
                        
                        for i = 1, 6 do
                            if EmoteChanger.emoteEnabled[i] and 
                               EmoteChanger.currentEmotes[i] ~= "" and 
                               args[1] == EmoteChanger.currentEmotes[i] then
                                
                                -- Block original emote
                                EmoteChanger.blockOriginalEmote = true
                                
                                task.spawn(function()
                                    task.wait(0.05)
                                    
                                    -- Fire the replacement emote
                                    if EmoteChanger.selectEmotes[i] ~= "" then
                                        pcall(function()
                                            EmoteRemote:FireServer(EmoteChanger.selectEmotes[i])
                                        end)
                                    end
                                    
                                    EmoteChanger.blockOriginalEmote = false
                                end)
                                
                                if EmoteChanger.blockOriginalEmote then
                                    return nil
                                end
                            end
                        end
                    end
                    
                    return oldHook(self, ...)
                end)
                
                print("‚úÖ Emote hook installed for Solara")
            end)
            
            -- Status display
            VisualTab:Section({Title = "Status"})
            VisualTab:Paragraph({
                Title = "Emote Changer Pro",
                Desc = "Executor: " .. executor .. "\nStatus: Ready\nSlots: 6\nVersion: 1.0",
                Image = "https://cdn.discordapp.com/emojis/1102910131167498311.png",
                ImageSize = 48,
                Buttons = {}
            })
            
            -- Select first tab
            Window:SelectTab(1)
            
            print("‚úÖ Emote Changer loaded successfully!")
            print("‚úÖ Executor:", executor)
            print("‚úÖ Solara support: Active")
            
        else
            -- Fallback if WindUI fails
            warn("‚ö†Ô∏è Using fallback UI for Solara")
            createFallbackUI()
        end
        
    else
        warn("‚ùå Not in Roblox environment")
    end
end)

if not success then
    warn("‚ùå Script error:", err)
    
    -- Show error message if in Roblox
    if game and game:GetService("Players") then
        local player = game:GetService("Players").LocalPlayer
        if player then
            local gui = Instance.new("ScreenGui")
            gui.Parent = player:WaitForChild("PlayerGui")
            
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(0, 300, 0, 150)
            frame.Position = UDim2.new(0.5, -150, 0.5, -75)
            frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            frame.Parent = gui
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -20, 1, -20)
            label.Position = UDim2.new(0, 10, 0, 10)
            label.Text = "‚ùå Script Error:\n" .. tostring(err)
            label.TextColor3 = Color3.fromRGB(255, 100, 100)
            label.TextWrapped = true
            label.BackgroundTransparency = 1
            label.Parent = frame
        end
    end
end
